# Quorum

通过要求多数人做出每个决定，避免两组服务器做出独立的决定。

[TOC]





## 问题

​		在分布式系统中，每当服务器采取任何行动时，它都需要确保在发生崩溃时这些行动的结果对客户端可用。 这可以通过将结果复制到集群中的其他服务器来实现。 但这导致了一个问题：在原始服务器可以确信更新被完全识别之前，需要多少其他服务器来确认复制。 如果原始服务器等待太多复制，那么它将响应缓慢 - 降低活跃度。 但是如果它没有足够的复制，那么更新可能会丢失 - 安全失败。 在整体系统性能和系统连续性之间取得平衡至关重要。

```asciiarmor
安全与活力
活力Liveness是系统的属性，系统总是在运行。 安全性Safety是表示系统始终处于正确状态的属性。 如果我们只关注安全，那么整个系统可能不会取得进展。 如果我们只关注活性，那么安全性可能会受到影响。
```



## 解决方案

​		当集群中的大多数节点已确认更新时，集群同意它已收到更新。 我们称这个数字为法定人数。 因此，如果我们有一个由五个节点组成的集群，我们需要三个法定人数。 （对于一个有 n 个节点的集群，法定人数是 n/2 + 1。）

​		对法定人数的需求表明可以容忍多少故障 - 这是集群的大小减去法定人数。 一个由五个节点组成的集群可以容忍其中两个节点发生故障。 一般来说，如果我们想容忍“f”个故障，我们需要一个 2f + 1 的集群大小

考虑以下两个需要法定人数的示例：

​		**更新服务器集群中的数据**：High-Water Mark 用于确保只有保证在大多数服务器上可用的数据对客户端可见。
​		**领导者选举**： 在领导者和追随者中，领导者只有在获得大多数服务器的投票时才会被选中。



### 确定集群中的服务器数量

​	只有当大多数服务器都启动并运行时，集群才能运行。在进行数据复制的系统中，需要考虑两件事：

**写操作的吞吐量。**
每次将数据写入集群时，都需要将数据复制到多个服务器。每个额外的服务器都会增加一些开销来完成此写入。数据写入的延迟与构成仲裁的服务器数量成正比。正如我们将在下面看到的，将集群中的服务器数量增加一倍会将吞吐量降低到原始集群的一半。

**需要容忍的故障数。**
允许的服务器故障数取决于集群的大小。但是仅仅向现有集群添加一台服务器并不总是提供更多的容错能力：向三服务器集群添加一台服务器不会增加容错能力。

考虑到这两个因素，大多数实用的基于仲裁的系统的集群大小为 3 或 5。一个五服务器集群可以容忍两台服务器故障，并且可以容忍每秒几千个请求的数据写入吞吐量。

下面是一个示例，说明如何根据允许的故障数量和对吞吐量的大致影响来选择服务器数量。吞吐量列显示了近似的相对吞吐量，以突出吞吐量随服务器数量的降低。该数字因系统而异。作为例子，读者可以参考 Raft Thesis 和 Zookeeper 原论文中公布的实际吞吐量数据。

| 服务器数量 | 法定人数 | 允许的故障数 | Representative 吞吐量 |
| ---------- | -------- | ------------ | --------------------- |
| 1          | 1        | 0            | 100                   |
| 2          | 2        | 0            | 85                    |
| 3          | 2        | 1            | 82                    |
| 4          | 3        | 1            | 57                    |
| 5          | 3        | 2            | 48                    |
| 6          | 4        | 2            | 41                    |
| 7          | 4        | 3            | 36                    |



## 例子

Zab、Raft、Paxos 等所有共识实现都是基于 法定人数的。
即使在不使用共识的系统中，法定人数也用于确保在发生故障或网络分区时至少一台服务器可以使用最新更新。 例如，在 Cassandra 等数据库中，可以将数据库更新配置为仅在大多数服务器成功更新记录后才返回成功。